<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>涨幅速览</title>
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.11.1/dist/index.css">
  <script src="https://unpkg.com/vue@3.5.20/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus@2.11.1/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.2/dist/index.iife.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #imgbox {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }

    .type_1 {
      position: relative;
      z-index: 2;
      display: block;
      border: 1px solid #ddd;
      margin: 2px;
      height: 170px;
      width: calc(50% - 4px);
    }

    .type_status {
      position: absolute;
      right: 3px;
      bottom: 3px;
      z-index: 4;
      font-size: 24px;
      color: #000;
    }

    .type_status.top {
      font-size: 24px;
      color: red;
    }

    .type_status.down {
      color: #0e48ff;
      font-size: 24px;
    }

    .type_1 img {
      width: 100%;
      height: 100%;
    }

    .lianghua_line {
      padding: 5px 0;
    }

    .color-red {
      color: red;
    }

    .color-green {
      color: #090;
    }

    .line-item {
      width: 100%;
      display: flex;
      padding: 2px 4px;
      gap: 2px;
    }

    @media (min-width: 1440px) {
      .line-item {
        width: calc(50% - 2px);
      }
    }

    .type_2 {
      position: relative;
      z-index: 2;
      display: block;
      /* border: 1px solid #ddd; */
      margin: 2px;
      height: 180px;
      width: calc(50% - 4px);
    }

    .type_2 img {
      width: 100%;
      height: 170px;
      border: 1px solid #ddd;
    }

    .zhang_today {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
    }
  </style>
</head>

<body>
  <div id="app" style="padding: 4px 0px 15px 0px;">
    <div id="imgwrapper">
      <div id="imgbox">
        <div class="line-item" v-for="(item, index) in tableData" :key="index">
          <div class="type_2">
            <img :src="`http://j3.dfcfw.com/images/JJJZ1/${item.fund_code}.png`" alt="" />
          </div>

          <template v-if="item.fund_sign === '正常' && item.zhang_url.startsWith('http')">
            <a class="type_1" :href="`https://fund.eastmoney.com/${item.fund_code}.html`" target="_blank">
              <img :src="item.zhang_url" :alt="item.fund_name || item.fund_code" />
            </a>
          </template>

          <template v-else>
            <div class="type_1">
              <div style="padding:0 0 0 2px;font-size:12px;color:#000;">{{item.fund_code}}-{{item.fund_name}}</div>
              <div class="zhang_today" v-html="getzhanghtml(item.zhang_today)"></div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, reactive } = Vue;
    const info = reactive({
      arr_1: [],// 综合的
      arr_2: [],// 常规的
      isRendered: false // 添加标志，用于防止重复渲染
    });

    function initVue3() {
      const app = createApp({
        data() {
          return {
            // isMobile: isMobile,
            // width_name: isMobile ? 146 : 220, // 基金名称列的宽度
            tableData: info.arr_1 || []
          };
        },
        mounted() {
          if (!info.isRendered) {
            console.log('info.arr_1', info.arr_1);
            render_2(info.arr_1);
            info.isRendered = true;
          }
        },
        methods: {
          getzhanghtml(data) {
            if (data !== '-') {
              if (Number(data) >= 0) {
                return `<span class="color-red">${data}</span>`;
              } else {
                return `<span class="color-green">${data}</span>`;
              }
            } else {
              return '-';
            }
          }
        },
      });

      app.use(ElementPlus);
      for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);// 循环注册图标
      }
      app.mount('#app');
    }


    // fetch('http://127.0.0.1:9999/fund_manage_fund_query', { method: 'post' })
    fetch('http://150.158.175.108:9999/fund_manage_fund_query', { method: 'post' })
      .then(res => res.json())
      .then(res => {
        if (res.code === 200) {
          let arr_1 = res.data.data || [];
          let arr_2 = [];// 常规要展示图形的

          let html = '';
          arr_1.forEach(item => {
            item.zhang_today = '-';// 浸提涨幅
            item.zhang_his = [];// 历史涨幅

            if (item.fund_sign === '正常' && item.zhang_url.startsWith('http')) {
              arr_2.push(item);
            }

          });

          info.arr_1 = [...arr_1];
          info.arr_2 = [...arr_2];

          initVue3();// 初始化表格
        } else {
          ElementPlus.ElMessage.error(res.msg || res.message || '数据出错')
        }

      }).catch(err => {
        ElementPlus.ElMessage.error(err.msg || err.message || '程序报错')
      })

    // 需要服务器监听的
    function render_2(arr) {
      arr.forEach((item, index) => {
        setTimeout(() => {
          const script = document.createElement('script');
          script.src = `https://fundgz.1234567.com.cn/js/${item.fund_code}.js`;
          document.body.appendChild(script);

          // getHistoryPerformance(item.fund_code);// 获取历史表现数据
        }, (index + 1) * 66)
      })
    }

    // 获取历史数据
    function getHistoryPerformance(fundcode) {
      fetch('http://150.158.175.108:9999/fund_history_performance', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fundcode: fundcode,
        })
      }).then(res => res.json()).then(res => {
        if (res.code === 200) {
          info.arr_1.forEach((item, index) => {
            if (item.fund_code === fundcode && (!item.zhang_his || item.zhang_his.length === 0)) {
              item.zhang_his = res.data || [];
            }
          })
        } else {
          ElementPlus.ElMessage.error(res.msg || res.message || '数据出错')
        }
      }).catch(err => {
        ElementPlus.ElMessage.error(err.msg || err.message || '程序报错')
      })
    }

    function jsonpgz(data) {
      /*
        {
          "fundcode": "002834",
          "name": "华夏新锦绣混合C",
          "jzrq": "2025-08-12",
          "dwjz": "2.7597",
          "gsz": "2.7728",
          "gszzl": "0.48",
          "gztime": "2025-08-13 15:00"
        }
      */
      if (!data) {
        return false;
      }
      info.arr_1.forEach(item => {
        if (item.fund_code === data.fundcode) {
          item.zhang_today = data.gszzl || '-';
          item.dwjz = ['', null, undefined].includes(data.dwjz) ? '' : data.dwjz;
        }
      })
    }
  </script>
</body>

</html>