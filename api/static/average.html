<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>涨幅均线</title>
  <link rel="stylesheet" href="./public/atom.css">
</head>

<body>
  <div class="average_wrapper">
    <!-- 常规的 -->
    <div class="average_box_1" id="average_box_1"></div>

    <!-- 量化等需要服务器的 -->
    <div class="average_box_2" id="average_box_2"></div>
  </div>


  <script src="./public/jquery.min.js"></script>
  <script src="./public/echarts.min.js"></script>
  <script>
    let arr_2 = [];// 常规的
    let arr_3 = [];// 需要服务器监听的
    // 实时涨幅的对象
    let cur_val_obj = {};

    fetch('http://150.158.175.108:9999/fund_public_fund').then(res => res.json()).then(res => {
      // console.log('res', res);
      let arr_1 = res.data || [];

      // 渲染基础的html结构
      arr_1.forEach(item => {
        // cur_val_obj[item.code] = {
        //   cur: '',// 当前涨幅
        //   data: [],// 历史累计净值
        // }
        if (item.zhang_url === '服务器监听') {
          arr_3.push(item)
        } else if (!['不提供'].includes(item.zhang_url)) {
          arr_2.push(item)
        }
      })
      // 临时模拟两个
      arr_2.length = 1;
      arr_3.length = 1;
      arr_1 = [...arr_2, ...arr_3];

      arr_1.forEach(item => {
        cur_val_obj[item.code] = {
          cur: '',// 当前涨幅
          data: [],// 历史累计净值
        }
      })

      render_1(arr_2);
      render_2(arr_3);

      // 获取涨幅
      arr_1.forEach(item => {
        const script = document.createElement('script');
        script.src = `https://fundgz.1234567.com.cn/js/${item.code}.js`;
        document.body.appendChild(script);
      })

      // 请求历史数据
      arr_1.forEach((item, index) => {
        setTimeout(() => {
          getChatData(item.code)
        }, index * 15 + 10)
      })
    }).catch(err => {
      console.log('err', err);
    })

    // 常规的
    function render_1(arr) {
      let html = '';
      arr.forEach((item) => {
        let str = '';

        let altstr = item.name || item.code;
        if (!item.zhang_url) {
          img = `<img class="average_img_1" src="https://j4.dfcfw.com/charts/pic6/${item.code}.png" alt="${altstr}">`
        } else {
          img = `<img class="average_img_1" src="${item.zhang_url}" alt="${altstr}">`
        }

        html += `<div class="average_item_1">
          <div class="average_left_1">
            <a href="https://fund.eastmoney.com/${item.code}.html" target="_blank" rel="noopener">${img}</a>
          </div>
          <div class="average_right_1">
            <div id="chart_${item.code}" class="average_chart"></div>
          </div>
        </div>`;
      })
      document.getElementById('average_box_1').innerHTML = html;
    }

    // 需要服务器监听的
    function render_2(arr) {
      let html = '';
      arr.forEach(item => {
        html += `<div class="average_item_2">
          <div class="average_title_2_box">
            <div class="average_line_2_1">${item.name}(${item.code})</div>
            <div class="average_line_2_2" id="id_${item.code}">当前净值未知</div>
          </div>
          <div class="average_chart_2">
            <div id="chart_${item.code}" class="average_chart"></div>
          </div>
        </div>`;
      })
      document.getElementById('average_box_2').innerHTML = html;
    }

    function jsonpgz(data) {
      if (!data) {
        return;
      }
      cur_val_obj[data.fundcode].cur = data.gszzl;// 绑定单位净值
      renderChart(data.fundcode);

      let code_arr_3 = arr_3.map(v => v.code);
      if (code_arr_3.includes(data.fundcode)) {
        let zhang_class = '';
        if (Number(data.gszzl) > 0) zhang_class = 'color-red';
        if (Number(data.gszzl) < 0) zhang_class = 'color-green';

        document.getElementById('id_' + data.fundcode).innerHTML = `${data.dwjz} ${data.gsz} <span class="${zhang_class}">${data.gszzl}</span> ${data.gztime}`;
      }
      // console.log('cur_val_obj[data.fundcode]', Object.keys(cur_val_obj).length, cur_val_obj);
    }

    // 请求历史数据数据
    function getChatData(code) {
      fetch('http://150.158.175.108:9999/fund_history_data', {
        method: 'post',
        headers: {
          'Content-Type': 'application/json', // 必须指定 JSON 格式
        },
        body: JSON.stringify({
          fundcode: code,
          pageSize: 9999
        })
      }).then(res => res.json()).then(res => {
        // console.log('fund_history_data', res);
        if (res.code === 200) {
          cur_val_obj[code].data = res.data;// 绑定单位净值
          renderChart(code);
        } else {
          alert(`401-${code}获取历史数据出错`)
        }
      }).catch(err => {
        console.log('err', err);
        alert(`400-${code}获取历史数据出错`)
      })
    }

    // 计算简单移动平均（SMA）
    function calculateSMA(data, period) {
      if (data.length < period) return []; // 数据不足
      const sma = [];
      for (let i = period - 1; i < data.length; i++) {
        const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
        sma.push(sum / period);
      }
      return sma;
    }

    // 计算标准差（Standard Deviation）
    function calculateStdDev(data, period, sma) {
      const stdDev = [];
      for (let i = period - 1; i < data.length; i++) {
        const slice = data.slice(i - period + 1, i + 1);
        const variance = slice.reduce((sum, value) => sum + Math.pow(value - sma[i - period + 1], 2), 0) / period;
        stdDev.push(Math.sqrt(variance));
      }
      return stdDev;
    }

    // 计算布林线三轨
    function calculateBollingerBands(data, period = 20, multiplier = 2) {
      const sma = calculateSMA(data, period); // 中轨
      const stdDev = calculateStdDev(data, period, sma); // 标准差

      const upperBand = sma.map((val, idx) => val + multiplier * stdDev[idx]); // 上轨
      const lowerBand = sma.map((val, idx) => val - multiplier * stdDev[idx]); // 下轨

      return { middleBand: sma, upperBand, lowerBand };
    }

    // 渲染图形
    function renderChart(code) {
      if (cur_val_obj[code].cur === '' || cur_val_obj[code].data.length === 0) {
        return false;
      }
      console.log('渲染图形', cur_val_obj[code]);

      const closePrices = [10, 12, 11, 13, 14, 15, 16, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 8, 9, 10];
      const { middleBand, upperBand, lowerBand } = calculateBollingerBands(closePrices);

      console.log("中轨:", middleBand);
      console.log("上轨:", upperBand);
      console.log("下轨:", lowerBand);

      // 以 ECharts 为例
      option = {
        xAxis: { data: ['Day1', 'Day2', 'Day3', 'Day4', 'Day5', 'Day6', 'Day7', 'Day8', 'Day9', 'Day10', 'Day11', 'Day12', 'Day13', 'Day14', 'Day15', 'Day16', 'Day17', 'Day18', 'Day19', 'Day20'] },
        yAxis: {},
        series: [
          { name: '上轨', data: upperBand, type: 'line' },
          { name: '中轨', data: middleBand, type: 'line' },
          { name: '下轨', data: lowerBand, type: 'line' }
        ]
      };

      //       {
      //   "netValueRowName": "单位净值",
      //   "totalNetValueRowName": "累计净值",
      //   "dateRowName": "日期",
      //   "dailyRateRowRate": "日涨跌幅"
      // }

      //       {
      //   "date": "2020-01-06",
      //   "netValue": "1.0790",
      //   "dailyProfit": "-0.41",
      //   "totalNetValue": "1.0790"
      // }
    }

  </script>
</body>

</html>