<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>涨幅速览</title>
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.11.1/dist/index.css">
  <script src="https://unpkg.com/vue@3.5.20/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus@2.11.1/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.2/dist/index.iife.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #imgbox {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }

    .type_1 {
      display: block;
      border: 1px solid #ddd;
      margin: 2px;
      height: 120px;
      width: calc(50% - 4px);
    }

    .type_1 img {
      width: 100%;
      height: 100%;
    }

    @media (min-width: 1440px) {
      .type_1 {
        width: calc(33.33% - 4px);
        height: 140px;
      }
    }

    @media (min-width: 1677px) {
      .type_1 {
        width: calc(25% - 4px);
        height: 140px;
      }
    }

    .lianghua_line {
      padding: 5px 0;
    }

    .color-red {
      color: red;
    }

    .color-green {
      color: #090;
    }

    .el-table .cell {
      padding: 0 5px !important;
    }

    .el-table .el-table__cell {
      padding: 2px 0;
    }
  </style>
</head>

<body>
  <div id="imgbox"></div>
  <div id="app" style="padding: 10px 15px;"></div>

  <div id="table_wrapper_1" style="display: none;">
    <el-table :data="tableData" style="width: 100%" border stripe max-height="520">
      <el-table-column fixed type="index" align="center" label="序" width="40"></el-table-column>
      <el-table-column fixed prop="code" align="center" label="基金号" width="80"></el-table-column>
      <el-table-column prop="name" label="Name" min-width="220" show-overflow-tooltip></el-table-column>

      <el-table-column align="right" label="今日">
        <template v-slot="{ row }">
          <span v-html="getToday(row)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="近一周">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,0)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="近1月">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,1)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="近3月">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,2)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="近6月">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,3)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="近1年">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,4)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="近3年">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,5)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="近5年">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,6)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="今年">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,7)"></span>
        </template>
      </el-table-column>

      <el-table-column align="right" label="成立">
        <template v-slot="{ row }">
          <span v-html="getHisdata(row,8)"></span>
        </template>
      </el-table-column>
    </el-table>
  </div>

  <!-- 量化 -->
  <div id="lianghua_box" style="padding: 10px 10px 20px 10px;"></div>

  <script>
    const { createApp, reactive } = Vue;
    const info = reactive({
      arr_1: [],// 综合的
      arr_2: [],// 常规的
      arr_3: [],// 需要服务器监听的
    });

    function initVue3() {
      const app = createApp({
        data() {
          return {
            tableData: info.arr_1 || []
          };
        },
        methods: {
          getHisdata(row, index) {
            let obj = row.zhang_his[index] || {};
            if (obj.hasOwnProperty('avg')) {
              if (Number(obj.avg) >= 0) {
                return `<span class="color-red">${obj.avg}</span>`
              } else {
                return `<span class="color-green">${obj.avg}</span>`
              }
            } else {
              return '-';
            }
          },
          getToday(row) {
            if (row.zhang_today !== '-') {
              if (Number(row.zhang_today) >= 0) {
                return `<span class="color-red">${row.zhang_today}</span>`
              } else {
                return `<span class="color-green">${row.zhang_today}</span>`
              }
            } else {
              return '-';
            }
          },
        },
        template: document.getElementById('table_wrapper_1').innerHTML
      });

      app.use(ElementPlus);
      for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);// 循环注册图标
      }
      app.mount('#app');
    }

    fetch('http://150.158.175.108:9999/fund_public_fund').then(res => res.json()).then(res => {
      console.log('res', res);
      let arr_1 = res.data || [];
      let arr_2 = [];
      let arr_3 = [];

      arr_1.forEach(item => {
        item.zhang_today = '-';// 浸提涨幅
        item.zhang_his = [];// 历史涨幅

        if (item.zhang_url === '服务器监听') {
          arr_3.push(item)
        } else if (!['不提供'].includes(item.zhang_url)) {
          arr_2.push(item)
        }
      });
      console.log('arr_2', arr_2);
      console.log('arr_3', arr_3);

      info.arr_1 = arr_1;
      info.arr_2 = arr_2;
      info.arr_3 = arr_3;

      render_1(info.arr_2);// 常规的
      render_2(info.arr_1);//

      console.log('info-193', info);


      initVue3();
    }).catch(err => {
      console.log('err', err);
    })

    // 常规的
    function render_1(arr) {
      let html = arr
        .map(
          (item) => {
            let altstr = item.name || item.code;
            if (!item.zhang_url) {
              return `<a class="type_1" href="https://fund.eastmoney.com/${item.code}.html" target="_blank"><img src="https://j4.dfcfw.com/charts/pic6/${item.code}.png" alt="${altstr}" /></a>`
            } else {
              return `<a class="type_1" href="https://fund.eastmoney.com/${item.code}.html" target="_blank"><img src="${item.zhang_url}" alt="${altstr}"></a>`
            }
          }
        )
        .join('');
      document.getElementById('imgbox').innerHTML = html;
    }

    // 需要服务器监听的
    function render_2(arr, options) {
      if (!!(options || {}).split) {
        let tempDiv = document.createElement('hr');
        document.getElementById('lianghua_box').appendChild(tempDiv); '';
      }
      arr.forEach((item, index) => {
        setTimeout(() => {
          const script = document.createElement('script');
          script.src = `https://fundgz.1234567.com.cn/js/${item.code}.js`;
          document.body.appendChild(script);
        }, index * 10)
      })
    }

    // 获取历史数据
    function getHistoryPerformance(fundcode) {
      fetch('http://150.158.175.108:9999/fund_history_performance', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fundcode: fundcode,
        })
      }).then(res => res.json()).then(res => {
        if (res.code === 200) {
          info.arr_2.forEach(item => {
            if (item.code === fundcode) {
              item.zhang_his = res.data || [];
            }
          })
          info.arr_3.forEach(item => {
            if (item.code === fundcode) {
              item.zhang_his = res.data || [];
            }
          })
        }

      }).catch(err => {
        console.log('err', err);
      })
    }

    function jsonpgz(data) {
      /*
        {
          "fundcode": "002834",
          "name": "华夏新锦绣混合C",
          "jzrq": "2025-08-12",
          "dwjz": "2.7597",
          "gsz": "2.7728",
          "gszzl": "0.48",
          "gztime": "2025-08-13 15:00"
        }
      */


      if (!data) {
        return false;
      }
      console.log('jsonpgz - data', data);
      info.arr_2.forEach(item => {
        if (item.code === data.fundcode) {
          item.zhang_today = data.gszzl || '-';
        }
      })
      info.arr_3.forEach(item => {
        if (item.code === data.fundcode) {
          item.zhang_today = data.gszzl || '-';
        }
      })
      getHistoryPerformance(data.fundcode);// 获取历史表现数据
    }


  </script>
</body>

</html>