<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="./atom.css">
  <style>
    body {
      padding: 10px;
    }

    #id_chart_wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chart_item {
      width: 400px;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow: hidden;
    }

    .chart_title {
      /* 溢出显式... */
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px;
      padding: 1px 4px;
      border-bottom: 1px solid #ccc;
    }

    .chart_box {
      width: 100%;
      height: 340px;
    }
  </style>
</head>

<body>
  <div id="id_chart_wrapper"></div>

  <script src="./jquery.min.js"></script>
  <script src="./echarts.min.js"></script>

  <script>
    async function getFund(code, index) {
      console.log(`正在请求第 ${index + 1} 个基金数据 ~~~`);
      let u = `../HistoryNetValue/${code}.json`;
      return fetch(u)
        .then((res) => res.json())
        .then((res) => {
          return res || [];
        });
    }

    async function renderchart(obj) {
      // {"date":"2024-12-11","netValue":"1.1257","dailyProfit":"0.46","totalNetValue":"1.6539"}
      const dates = obj.fundData.map(item => item.date);
      const netValues = obj.fundData.map(item => item.totalNetValue);

      const myChart = echarts.init(document.getElementById(obj.chartId));

      // 获取totalNetValue的最大值和最小值
      const maxNetValue = Math.max(...netValues);
      const minNetValue = Math.min(...netValues);

      const option = {
        // title: {
        //   text: `${obj.fundName}`
        // },
        color: ['#e34641'],
        tooltip: {
          trigger: 'axis'
        },
        grid: {
          top: 30,
          right: 5,
          bottom: 5,
          left: 5,
          containLabel: true
        },
        dataZoom: [{
          type: 'inside',
          start: 0,
          end: 100
        },
        ],
        xAxis: {
          type: 'category',
          data: dates,
          axisLine: { show: false }, // Hide x-axis line
          axisTick: { show: false }, // Hide x-axis ticks
          axisLabel: { show: false }, // Hide x-axis labels
          splitLine: { show: false } // Hide grid lines
        },
        yAxis: {
          type: 'value',
          max: maxNetValue,
          min: minNetValue,
          axisLine: { show: false }, // Hide y-axis line
          axisTick: { show: false }, // Hide y-axis ticks
          // axisLabel: { show: false }, // Hide y-axis labels
          // splitLine: { show: false } // Hide grid lines
        },
        series: [{
          name: '净值',
          type: 'line',
          data: netValues,
          smooth: true,
          label: {
            show: false,
          },
          symbolSize: 0
        }]
      };

      // Render the chart
      myChart.setOption(option);
    }

    // https://fund.eastmoney.com/004335.html
    $('#id_chart_wrapper').on('click', '.chart_box', function () {
      const fundCode = $(this).prev('.chart_title').text().split(' -- ')[0];
      window.open(`https://fund.eastmoney.com/${fundCode}.html`, '_blank');
    });

    async function fetchFunds() {
      const response = await fetch('../data/filter.json');
      const funds = await response.json();
      console.log(`[funds]`, funds);

      for (let index = 0; index < funds.length; index++) {
        const item = funds[index];
        const chartItem = $(`
          <div class="chart_item">
            <div class="chart_title">${item.fund_code} -- ${item.fund_name}</div>
            <div class="chart_box" id="id_chart_${item.fund_code}"></div>
          </div>
        `);
        $('#id_chart_wrapper').append(chartItem);
      }

      for (let index = 0; index < funds.length; index++) {
        await new Promise((resolve) => setTimeout(resolve, 50));
        const item = funds[index];
        const fundData = await getFund(item.fund_code, index);

        if (fundData.length > 0) {
          await renderchart({
            chartId: `id_chart_${item.fund_code}`,
            fundData,
            fundName: item.fund_name,
            fundCode: item.fund_code,
          });
        }
      }
    }

    fetchFunds();
  </script>
</body>

</html>